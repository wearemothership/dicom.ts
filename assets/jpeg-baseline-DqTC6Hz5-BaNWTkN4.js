const Q={Unkown:0,Grayscale:1,AdobeRGB:2,RGB:3,CYMK:4},me=function(){var _=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),Z=4017,ee=799,ne=3406,oe=2276,ae=1567,re=3784,K=5793,te=2896;function se(){}function fe(t,h){for(var e=0,w=[],n,b,u=16;u>0&&!t[u-1];)u--;w.push({children:[],index:0});var o=w[0],l;for(n=0;n<u;n++){for(b=0;b<t[n];b++){for(o=w.pop(),o.children[o.index]=h[e];o.index>0;)o=w.pop();for(o.index++,w.push(o);w.length<=n;)w.push(l={children:[],index:0}),o.children[o.index]=l.children,o=l;e++}n+1<u&&(w.push(l={children:[],index:0}),o.children[o.index]=l.children,o=l)}return w[0].children}function $(t,h,e){return 64*((t.blocksPerLine+1)*h+e)}function ue(t,h,e,w,n,b,u,o,l){e.precision,e.samplesPerLine,e.scanLines;var i=e.mcusPerLine,v=e.progressive;e.maxH,e.maxV;var d=h,a=0,c=0;function r(){if(c>0)return c--,a>>c&1;if(a=t[h++],a==255){var f=t[h++];if(f)throw"unexpected marker: "+(a<<8|f).toString(16)}return c=7,a>>>7}function s(f){for(var k=f,y;(y=r())!==null;){if(k=k[y],typeof k=="number")return k;if(typeof k!="object")throw"invalid huffman sequence"}return null}function p(f){for(var k=0;f>0;){var y=r();if(y===null)return;k=k<<1|y,f--}return k}function L(f){var k=p(f);return k>=1<<f-1?k:k+(-1<<f)+1}function V(f,k){var y=s(f.huffmanTableDC),B=y===0?0:L(y);f.blockData[k]=f.pred+=B;for(var m=1;m<64;){var D=s(f.huffmanTableAC),U=D&15,q=D>>4;if(U===0){if(q<15)break;m+=16;continue}m+=q;var N=_[m];f.blockData[k+N]=L(U),m++}}function g(f,k){var y=s(f.huffmanTableDC),B=y===0?0:L(y)<<l;f.blockData[k]=f.pred+=B}function A(f,k){f.blockData[k]|=r()<<l}var G=0;function C(f,k){if(G>0){G--;return}for(var y=b,B=u;y<=B;){var m=s(f.huffmanTableAC),D=m&15,U=m>>4;if(D===0){if(U<15){G=p(U)+(1<<U)-1;break}y+=16;continue}y+=U;var q=_[y];f.blockData[k+q]=L(D)*(1<<l),y++}}var T=0,j;function J(f,k){for(var y=b,B=u,m=0;y<=B;){var D=_[y];switch(T){case 0:var U=s(f.huffmanTableAC),q=U&15;if(m=U>>4,q===0)m<15?(G=p(m)+(1<<m),T=4):(m=16,T=1);else{if(q!==1)throw"invalid ACn encoding";j=L(q),T=m?2:3}continue;case 1:case 2:f.blockData[k+D]?f.blockData[k+D]+=r()<<l:(m--,m===0&&(T=T==2?3:0));break;case 3:f.blockData[k+D]?f.blockData[k+D]+=r()<<l:(f.blockData[k+D]=j<<l,T=0);break;case 4:f.blockData[k+D]&&(f.blockData[k+D]+=r()<<l);break}y++}T===4&&(G--,G===0&&(T=0))}function H(f,k,y,B,m){var D=y/i|0,U=y%i,q=D*f.v+B,N=U*f.h+m,ce=$(f,q,N);k(f,ce)}function z(f,k,y){var B=y/f.blocksPerLine|0,m=y%f.blocksPerLine,D=$(f,B,m);k(f,D)}var x=w.length,M,I,W,R,F,Y;v?b===0?Y=o===0?g:A:Y=o===0?C:J:Y=V;var O=0,S,P;x==1?P=w[0].blocksPerLine*w[0].blocksPerColumn:P=i*e.mcusPerColumn,n||(n=P);for(var ie,E;O<P;){for(I=0;I<x;I++)w[I].pred=0;if(G=0,x==1)for(M=w[0],F=0;F<n;F++)z(M,Y,O),O++;else for(F=0;F<n;F++){for(I=0;I<x;I++)for(M=w[I],ie=M.h,E=M.v,W=0;W<E;W++)for(R=0;R<ie;R++)H(M,Y,O,W,R);O++}if(c=0,S=t[h]<<8|t[h+1],S<=65280)throw"marker was not found";if(S>=65488&&S<=65495)h+=2;else break}return h-d}function le(t,h,e){var w=t.quantizationTable,n,b,u,o,l,i,v,d,a,c;for(c=0;c<64;c++)e[c]=t.blockData[h+c]*w[c];for(c=0;c<8;++c){var r=8*c;if(e[1+r]===0&&e[2+r]===0&&e[3+r]===0&&e[4+r]===0&&e[5+r]===0&&e[6+r]===0&&e[7+r]===0){a=K*e[0+r]+512>>10,e[0+r]=a,e[1+r]=a,e[2+r]=a,e[3+r]=a,e[4+r]=a,e[5+r]=a,e[6+r]=a,e[7+r]=a;continue}n=K*e[0+r]+128>>8,b=K*e[4+r]+128>>8,u=e[2+r],o=e[6+r],l=te*(e[1+r]-e[7+r])+128>>8,d=te*(e[1+r]+e[7+r])+128>>8,i=e[3+r]<<4,v=e[5+r]<<4,a=n-b+1>>1,n=n+b+1>>1,b=a,a=u*re+o*ae+128>>8,u=u*ae-o*re+128>>8,o=a,a=l-v+1>>1,l=l+v+1>>1,v=a,a=d+i+1>>1,i=d-i+1>>1,d=a,a=n-o+1>>1,n=n+o+1>>1,o=a,a=b-u+1>>1,b=b+u+1>>1,u=a,a=l*oe+d*ne+2048>>12,l=l*ne-d*oe+2048>>12,d=a,a=i*ee+v*Z+2048>>12,i=i*Z-v*ee+2048>>12,v=a,e[0+r]=n+d,e[7+r]=n-d,e[1+r]=b+v,e[6+r]=b-v,e[2+r]=u+i,e[5+r]=u-i,e[3+r]=o+l,e[4+r]=o-l}for(c=0;c<8;++c){var s=c;if(e[1*8+s]===0&&e[2*8+s]===0&&e[3*8+s]===0&&e[4*8+s]===0&&e[5*8+s]===0&&e[6*8+s]===0&&e[7*8+s]===0){a=K*e[c+0]+8192>>14,e[0*8+s]=a,e[1*8+s]=a,e[2*8+s]=a,e[3*8+s]=a,e[4*8+s]=a,e[5*8+s]=a,e[6*8+s]=a,e[7*8+s]=a;continue}n=K*e[0*8+s]+2048>>12,b=K*e[4*8+s]+2048>>12,u=e[2*8+s],o=e[6*8+s],l=te*(e[1*8+s]-e[7*8+s])+2048>>12,d=te*(e[1*8+s]+e[7*8+s])+2048>>12,i=e[3*8+s],v=e[5*8+s],a=n-b+1>>1,n=n+b+1>>1,b=a,a=u*re+o*ae+2048>>12,u=u*ae-o*re+2048>>12,o=a,a=l-v+1>>1,l=l+v+1>>1,v=a,a=d+i+1>>1,i=d-i+1>>1,d=a,a=n-o+1>>1,n=n+o+1>>1,o=a,a=b-u+1>>1,b=b+u+1>>1,u=a,a=l*oe+d*ne+2048>>12,l=l*ne-d*oe+2048>>12,d=a,a=i*ee+v*Z+2048>>12,i=i*Z-v*ee+2048>>12,v=a,e[0*8+s]=n+d,e[7*8+s]=n-d,e[1*8+s]=b+v,e[6*8+s]=b-v,e[2*8+s]=u+i,e[5*8+s]=u-i,e[3*8+s]=o+l,e[4*8+s]=o-l}for(c=0;c<64;++c){var p=h+c,L=e[c];L=L<=-2056/t.bitConversion?0:L>=2024/t.bitConversion?255/t.bitConversion:L+2056/t.bitConversion>>4,t.blockData[p]=L}}function he(t,h){for(var e=h.blocksPerLine,w=h.blocksPerColumn,n=new Int32Array(64),b=0;b<w;b++)for(var u=0;u<e;u++){var o=$(h,b,u);le(h,o,n)}return h.blockData}function X(t){return t<=0?0:t>=255?255:t|0}return se.prototype={load:function(t){var h=(function(o){this.parse(o),this.onload&&this.onload()}).bind(this);if(t.indexOf("data:")>-1){for(var e=t.indexOf("base64,")+7,w=atob(t.substring(e)),n=new Uint8Array(w.length),b=w.length-1;b>=0;b--)n[b]=w.charCodeAt(b);h(w)}else{var u=new XMLHttpRequest;u.open("GET",t,!0),u.responseType="arraybuffer",u.onload=(function(){var o=new Uint8Array(u.response);h(o)}).bind(this),u.send(null)}},parse:function(t){function h(){var m=t[n]<<8|t[n+1];return n+=2,m}function e(){var m=h(),D=t.subarray(n,n+m-2);return n+=D.length,D}function w(m){for(var D=Math.ceil(m.samplesPerLine/8/m.maxH),U=Math.ceil(m.scanLines/8/m.maxV),q=0;q<m.components.length;q++){P=m.components[q];var N=Math.ceil(Math.ceil(m.samplesPerLine/8)*P.h/m.maxH),ce=Math.ceil(Math.ceil(m.scanLines/8)*P.v/m.maxV),be=D*P.h,pe=U*P.v,de=64*pe*(be+1);P.blockData=new Int16Array(de),P.blocksPerLine=N,P.blocksPerColumn=ce}m.mcusPerLine=D,m.mcusPerColumn=U}var n=0;t.length;var b=null,u=null,o,l,i=[],v=[],d=[],a=h();if(a!=65496)throw"SOI not found";for(a=h();a!=65497;){var c,r,s;switch(a){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var p=e();a===65504&&p[0]===74&&p[1]===70&&p[2]===73&&p[3]===70&&p[4]===0&&(b={version:{major:p[5],minor:p[6]},densityUnits:p[7],xDensity:p[8]<<8|p[9],yDensity:p[10]<<8|p[11],thumbWidth:p[12],thumbHeight:p[13],thumbData:p.subarray(14,14+3*p[12]*p[13])}),a===65518&&p[0]===65&&p[1]===100&&p[2]===111&&p[3]===98&&p[4]===101&&p[5]===0&&(u={version:p[6],flags0:p[7]<<8|p[8],flags1:p[9]<<8|p[10],transformCode:p[11]});break;case 65499:for(var L=h(),V=L+n-2;n<V;){var g=t[n++],A=new Int32Array(64);if(g>>4)if(g>>4===1)for(r=0;r<64;r++){var G=_[r];A[G]=h()}else throw"DQT: invalid table spec";else for(r=0;r<64;r++){var C=_[r];A[C]=t[n++]}i[g&15]=A}break;case 65472:case 65473:case 65474:if(o)throw"Only single frame JPEGs supported";h(),o={},o.extended=a===65473,o.progressive=a===65474,o.precision=t[n++],o.scanLines=h(),o.samplesPerLine=h(),o.components=[],o.componentIds={};var T=t[n++],j,J=0,H=0;for(c=0;c<T;c++){j=t[n];var z=t[n+1]>>4,x=t[n+1]&15;J<z&&(J=z),H<x&&(H=x);var M=t[n+2];s=o.components.push({h:z,v:x,quantizationTable:i[M],quantizationTableId:M,bitConversion:255/((1<<o.precision)-1)}),o.componentIds[j]=s-1,n+=3}o.maxH=J,o.maxV=H,w(o);break;case 65476:var I=h();for(c=2;c<I;){var W=t[n++],R=new Uint8Array(16),F=0;for(r=0;r<16;r++,n++)F+=R[r]=t[n];var Y=new Uint8Array(F);for(r=0;r<F;r++,n++)Y[r]=t[n];c+=17+F,(W>>4?v:d)[W&15]=fe(R,Y)}break;case 65501:h(),l=h();break;case 65498:h();var O=t[n++],S=[],P;for(c=0;c<O;c++){var ie=o.componentIds[t[n++]];P=o.components[ie];var E=t[n++];P.huffmanTableDC=d[E>>4],P.huffmanTableAC=v[E&15],S.push(P)}var f=t[n++],k=t[n++],y=t[n++],B=ue(t,n,o,S,l,f,k,y>>4,y&15);n+=B;break;case 65535:t[n]!==255&&n--;break;default:if(t[n-3]==255&&t[n-2]>=192&&t[n-2]<=254){n-=3;break}throw"unknown JPEG marker "+a.toString(16)}a=h()}switch(this.width=o.samplesPerLine,this.height=o.scanLines,this.jfif=b,this.adobe=u,this.components=[],o.components.length){case 1:this.colorspace=Q.Grayscale;break;case 3:this.adobe?this.colorspace=Q.AdobeRGB:this.colorspace=Q.RGB;break;case 4:this.colorspace=Q.CYMK;break;default:this.colorspace=Q.Unknown}for(var c=0;c<o.components.length;c++){var P=o.components[c];!P.quantizationTable&&P.quantizationTableId!==null&&(P.quantizationTable=i[P.quantizationTableId]),this.components.push({output:he(o,P),scaleX:P.h/o.maxH,scaleY:P.v/o.maxV,blocksPerLine:P.blocksPerLine,blocksPerColumn:P.blocksPerColumn,bitConversion:P.bitConversion})}},getData16:function(t,h){if(this.components.length!==1)throw"Unsupported color mode";var e=this.width/t,w=this.height/h,n,b,u,o,l,i,v=0,d=this.components.length,a=t*h*d,c=new Uint16Array(a),r=new Uint16Array((this.components[0].blocksPerLine<<3)*this.components[0].blocksPerColumn*8);for(i=0;i<d;i++){n=this.components[i];for(var s=n.blocksPerLine,p=n.blocksPerColumn,L=s<<3,V,g,A=0,G=0;G<p;G++)for(var C=G<<3,T=0;T<s;T++){var j=$(n,G,T),v=0,J=T<<3;for(V=0;V<8;V++){var A=(C+V)*L;for(g=0;g<8;g++)r[A+J+g]=n.output[j+v++]}}b=n.scaleX*e,u=n.scaleY*w,v=i;var H,z,x;for(l=0;l<h;l++)for(o=0;o<t;o++)z=0|l*u,H=0|o*b,x=z*L+H,c[v]=r[x],v+=d}return c},getData:function(t,h){var e=this.width/t,w=this.height/h,n,b,u,o,l,i,v=0,d,a,c,r,s,p,L,V,g,A=this.components.length,G=t*h*A,C=new Uint8Array(G),T=new Uint8Array((this.components[0].blocksPerLine<<3)*this.components[0].blocksPerColumn*8);for(i=0;i<A;i++){n=this.components[i];for(var j=n.blocksPerLine,J=n.blocksPerColumn,H=j<<3,z,x,M=0,I=0;I<J;I++)for(var W=I<<3,R=0;R<j;R++){var F=$(n,I,R),v=0,Y=R<<3;for(z=0;z<8;z++){var M=(W+z)*H;for(x=0;x<8;x++)T[M+Y+x]=n.output[F+v++]*n.bitConversion}}b=n.scaleX*e,u=n.scaleY*w,v=i;var O,S,P;for(l=0;l<h;l++)for(o=0;o<t;o++)S=0|l*u,O=0|o*b,P=S*H+O,C[v]=T[P],v+=A}switch(A){case 1:case 2:break;case 3:if(g=!0,this.adobe&&this.adobe.transformCode?g=!0:typeof this.colorTransform<"u"&&(g=!!this.colorTransform),g)for(i=0;i<G;i+=A)d=C[i],a=C[i+1],c=C[i+2],p=X(d-179.456+1.402*c),L=X(d+135.459-.344*a-.714*c),V=X(d-226.816+1.772*a),C[i]=p,C[i+1]=L,C[i+2]=V;break;case 4:if(!this.adobe)throw"Unsupported color mode (4 components)";if(g=!1,this.adobe&&this.adobe.transformCode?g=!0:typeof this.colorTransform<"u"&&(g=!!this.colorTransform),g)for(i=0;i<G;i+=A)d=C[i],a=C[i+1],c=C[i+2],r=X(434.456-d-1.402*c),s=X(119.541-d+.344*a+.714*c),d=X(481.816-d-1.772*a),C[i]=r,C[i+1]=s,C[i+2]=d;break;default:throw"Unsupported color mode"}return C}},se}();export{Q as ColorSpace,me as JpegImage};
